; Сказ о Яблочке (Bad Apple)
; Рендеринг 64x48, 1 бит на пиксель

ЗАЧИН:
    ; Очистка бересты (экрана) ANSI-кодами
    УКАЖИ П1, КУРСОР_ДОМОЙ
    ПОЛОЖИ П0, 27
    ВВЕРГНИ_БАЙТ П0, П1
    ПРИБАВЬ П1, П1, 1
    ПОЛОЖИ П0, 91
    ВВЕРГНИ_БАЙТ П0, П1
    ПРИБАВЬ П1, П1, 1
    ПОЛОЖИ П0, 72
    ВВЕРГНИ_БАЙТ П0, П1

    ; Песочные часы (Таймер 33мс)
    ; struct timespec { tv_sec, tv_nsec }
    УКАЖИ П1, ТАЙМЕР
    ПОЛОЖИ П0, 0
    ВВЕРГНИ П0, П1          ; секунды = 0
    ПРИБАВЬ П1, П1, 8
    ПОЛОЖИ П0, 0х1Е78А40    ; наносекунды = 33000000 (0x01F78A40)
    ВВЕРГНИ П0, П1

    ; Настройка свитков с видео
    УКАЖИ П19, ВИДЕО_НАЧАЛО
    УКАЖИ П20, ВИДЕО_КОНЕЦ

ГЛАВНЫЙ_КРУГ:
    СРАВНИ П19, П20
    КОЛИ_БОЛЬШЕ СТУПАЙ ВЫХОД

    ; Сброс пера в начало строки (курсор в 0,0)
    ПОЛОЖИ П0, 1         ; stdout
    УКАЖИ П1, КУРСОР_ДОМОЙ
    ПОЛОЖИ П2, 3         ; длина
    ПОЛОЖИ П8, 64        ; syscall write
    ДОЛОЖИ

    ; Рисование кадра
    УКАЖИ П21, ЭКРАН_БУФЕР
    ПРИБАВЬ П23, П19, 0  ; Текущий байт видео
    ПОЛОЖИ П22, 0        ; Счетчик прочитанных байт кадра
    ПОЛОЖИ П25, 0        ; Счетчик байт в строке

РИСУЙ_БАЙТЫ:
    ИЗЫМИ_БАЙТ П4, П23   ; Загружаем байт пикселей
    ПОЛОЖИ П5, 128       ; Битовая маска (10000000)

РИСУЙ_БИТЫ:
    СРАВНИ П4, П5
    КОЛИ_МЕНЬШЕ СТУПАЙ БИТ_НОЛЬ

БИТ_ОДИН:
    ПОЛОЖИ П6, 0х23      ; Символ '#'
    
    ; Пишем дважды для коррекции пропорций
    ВВЕРГНИ_БАЙТ П6, П21
    ПРИБАВЬ П21, П21, 1
    
    ВВЕРГНИ_БАЙТ П6, П21
    ПРИБАВЬ П21, П21, 1
    
    ВЫЧТИ П4, П4, П5     ; Сбрасываем бит в байте
    СТУПАЙ СЛЕД_БИТ

БИТ_НОЛЬ:
    ПОЛОЖИ П6, 0х20      ; Символ ' ' (пробел)
    
    ВВЕРГНИ_БАЙТ П6, П21
    ПРИБАВЬ П21, П21, 1
    
    ВВЕРГНИ_БАЙТ П6, П21
    ПРИБАВЬ П21, П21, 1

СЛЕД_БИТ:
    ; Сдвиг маски вправо (П5 / 2)
    ; Ибо деление - это по-нашему
    ПОЛОЖИ П7, 2
    РАЗДЕЛИ П5, П5, П7
    
    СРАВНИ П5, 0
    КОЛИ_НЕРАВНО СТУПАЙ РИСУЙ_БИТЫ

    ; Конец обработки одного байта видео
    ПРИБАВЬ П22, П22, 1
    ПРИБАВЬ П23, П23, 1
    ПРИБАВЬ П25, П25, 1

    ; Каждые 8 байт (64 пикселя) переносим строку
    СРАВНИ П25, 8
    КОЛИ_НЕРАВНО СТУПАЙ ДАЛЬШЕ_БАЙТЫ

    ; Добавляем \n для красоты
    ПОЛОЖИ П6, 0хА
    ВВЕРГНИ_БАЙТ П6, П21
    ПРИБАВЬ П21, П21, 1
    ПОЛОЖИ П25, 0

ДАЛЬШЕ_БАЙТЫ:
    ; Проверка конца кадра (384 байта)
    СРАВНИ П22, 384
    КОЛИ_МЕНЬШЕ СТУПАЙ РИСУЙ_БАЙТЫ

    ; Вывод буфера на экран (Flush)
    ; w: (64 * 2) + 1 = 129
    ; h: 48
    ; Размер: 129 * 48 = 6192 байта
    
    ПОЛОЖИ П0, 1            ; stdout
    УКАЖИ П1, ЭКРАН_БУФЕР
    ПОЛОЖИ П2, 6192         ; размер буфера
    ПОЛОЖИ П8, 64           ; syscall write
    ДОЛОЖИ

    ; Пауза 
    УКАЖИ П0, ТАЙМЕР
    ПОЛОЖИ П1, 0
    ПОЛОЖИ П8, 101          ; syscall nanosleep
    ДОЛОЖИ

    ; Переход к следующему кадру
    ПРИБАВЬ П19, П19, 384
    СТУПАЙ ГЛАВНЫЙ_КРУГ

ВЫХОД:
    ПОЛОЖИ П0, 0
    ПОЛОЖИ П8, 93           ; syscall exit
    ДОЛОЖИ
    ВЕРНИСЬ                 ; Формальный возврат

КУРСОР_ДОМОЙ: 
    ОТМЕРЬ 4
ТАЙМЕР:       
    ОТМЕРЬ 16

ЭКРАН_БУФЕР:  
    ОТМЕРЬ 6300 

ВИДЕО_НАЧАЛО: 
    ВЛОЖИ "bad_apple.bin"
ВИДЕО_КОНЕЦ:  
    СЛОВО "КОНЕЦ"